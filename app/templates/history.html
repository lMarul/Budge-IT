<!-- Marwin -->

{# 
    Transaction History Page Template
    
    This template displays a comprehensive view of user transaction history with:
    - Filtering options (time period and transaction type)
    - Summary statistics (total income, expenses, net balance)
    - Interactive charts for income and expense breakdown
    - Detailed transaction table with edit/delete functionality
    - Modal for editing transactions
    
    Features:
    - Responsive design with dark mode support
    - Real-time data filtering and chart updates
    - Interactive pie charts using Chart.js
    - AJAX-powered data loading
    - Transaction editing modal with form validation
#}

{% extends 'base.html' %}

{% block title %}History - Budget Tracker{% endblock %}

{% block content %}
{# Main container for the history page content #}
<div class="max-w-7xl mx-auto">
    {# Page header with title #}
    <h1 class="text-4xl font-bold text-primary mb-8 dark:text-dark-primary">Transaction History</h1>

    {# Auto-fade notifications - improved to show only one at a time #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="notifications-container" class="mb-6">
                {# Show only the last message to avoid multiple notifications #}
                {% set last_message = messages[-1] %}
                <div class="notification p-4 mb-2 text-sm rounded-lg transition-all duration-500 ease-in-out {% if last_message[0] == 'danger' %}bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200{% else %}bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200{% endif %}">
                    {{ last_message[1] }}
                </div>
            </div>
        {% endif %}
    {% endwith %}

    {# Filter controls section - allows users to filter transactions by time period and type #}
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8 dark:bg-dark-bg-2 dark:shadow-xl">
        <div class="flex flex-wrap gap-4 items-center">
            <label class="text-lg font-semibold text-gray-700 dark:text-dark-text">View:</label>
            {# Time period filter dropdown - controls what time range to display #}
            <select id="periodSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="year">This Year</option>
                <option value="all">All Time</option>
                <option value="custom">Custom Range</option>
            </select>
            {# Transaction type filter dropdown - allows filtering by income, expense, or both #}
            <select id="typeSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
                <option value="both">Income & Expenses</option>
                <option value="income">Income Only</option>
                <option value="expense">Expenses Only</option>
            </select>
            
            {# Custom date range pickers - hidden by default #}
            <div id="customDateRange" class="hidden flex gap-2 items-center">
                <label class="text-sm text-gray-600 dark:text-gray-400">From:</label>
                <input type="date" id="startDate" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
                <label class="text-sm text-gray-600 dark:text-gray-400">To:</label>
                <input type="date" id="endDate" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
                <button type="button" onclick="applyCustomRange()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                    Apply
                </button>
            </div>
        </div>
    </div>

    {# Summary statistics cards - displays total income, expenses, and net balance #}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        {# Total Income card - shows sum of all income transactions for selected period #}
        <div class="bg-white rounded-lg shadow-lg p-6 dark:bg-dark-bg-2 dark:shadow-xl">
            <h3 class="text-lg font-semibold text-gray-700 mb-2 dark:text-dark-text">Total Income</h3>
            <p id="totalIncome" class="text-3xl font-bold text-green-600 dark:text-green-300">₱0.00</p>
        </div>
        {# Total Expenses card - shows sum of all expense transactions for selected period #}
        <div class="bg-white rounded-lg shadow-lg p-6 dark:bg-dark-bg-2 dark:shadow-xl">
            <h3 class="text-lg font-semibold text-gray-700 mb-2 dark:text-dark-text">Total Expenses</h3>
            <p id="totalExpenses" class="text-3xl font-bold text-red-600 dark:text-red-300">₱0.00</p>
        </div>
        {# Net Balance card - shows the difference between income and expenses #}
        <div class="bg-white rounded-lg shadow-lg p-6 dark:bg-dark-bg-2 dark:shadow-xl">
            <h3 class="text-lg font-semibold text-gray-700 mb-2 dark:text-dark-text">Net Balance</h3>
            <p id="netBalance" class="text-3xl font-bold text-gray-800 dark:text-dark-text">₱0.00</p>
        </div>
    </div>

    {# Chart section - displays pie charts for income and expense breakdown by transaction #}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        {# Income breakdown chart - shows individual income transactions as pie chart #}
        <div class="bg-white rounded-lg shadow-lg p-6 dark:bg-dark-bg-2 dark:shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 dark:text-dark-text">Income Breakdown (By Transaction)</h2>
            <div class="relative h-64 chart-container">
                <canvas id="incomeChart"></canvas>
                {# No data message - displayed when no income data is available #}
                <div class="absolute inset-0 flex items-center justify-center hidden" id="incomeNoDataMessage">
                    <p class="text-gray-500 text-center dark:text-gray-400">No income data for this period</p>
                </div>
            </div>
            {# Chart legend - displays color-coded legend for income chart #}
            <div id="incomeChartLegend" class="mt-4 space-y-2"></div>
        </div>
        {# Expense breakdown chart - shows individual expense transactions as pie chart #}
        <div class="bg-white rounded-lg shadow-lg p-6 dark:bg-dark-bg-2 dark:shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 dark:text-dark-text">Expense Breakdown (By Transaction)</h2>
            <div class="relative h-64 chart-container">
                <canvas id="expenseChart"></canvas>
                {# No data message - displayed when no expense data is available #}
                <div class="absolute inset-0 flex items-center justify-center hidden" id="expenseNoDataMessage">
                    <p class="text-gray-500 text-center dark:text-gray-400">No expense data for this period</p>
                </div>
            </div>
            {# Chart legend - displays color-coded legend for expense chart #}
            <div id="expenseChartLegend" class="mt-4 space-y-2"></div>
        </div>
    </div>

    {# Transaction table section - displays detailed list of all transactions #}
    {% if transactions %}
    <div class="table-responsive bg-white rounded-lg shadow-lg p-6 overflow-x-auto dark:bg-dark-bg-2 dark:shadow-xl">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 dark:text-dark-text">All Transactions</h2>
        {# Transaction table with headers for each column #}
        <table class="table table-striped table-hover w-full text-left dark:text-dark-text">
            <thead>
                <tr>
                    <th class="py-2 px-4 border-b dark:border-gray-600 dark:text-gray-300">Date</th>
                    <th class="py-2 px-4 border-b dark:border-gray-600 dark:text-gray-300">Category</th>
                    <th class="py-2 px-4 border-b dark:border-gray-600 dark:text-gray-300">Item Name</th>
                    <th class="py-2 px-4 border-b dark:border-gray-600 dark:text-gray-300">Amount</th>
                    <th class="py-2 px-4 border-b dark:border-gray-600 dark:text-gray-300">Type</th>
                    <th class="py-2 px-4 border-b dark:border-gray-600 dark:text-gray-300">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {# Loop through each transaction and display in table row #}
                {% for transaction in transactions %}
                {# Table row with conditional styling based on transaction type (income/expense) #}
                <tr class="{{ 'bg-green-50 dark:bg-green-800' if transaction.transaction_type == 'income' else 'bg-red-50 dark:bg-red-800' }} border-b dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700" id="transaction-row-{{ transaction.id }}">
                    {# Transaction date column #}
                    <td class="py-2 px-4 text-sm text-gray-900 dark:text-dark-text">{{ transaction.date }}</td>
                    {# Category column with color-coded badge #}
                    <td class="py-2 px-4 text-sm text-gray-900 dark:text-dark-text">
                        <span class="badge px-2 py-1 rounded" style="background-color: {{ transaction.category_color if transaction.category_color else '#6c757d' }}; color: white;">{{ transaction.category_name }}</span>
                    </td>
                    {# Item Name column - shows item name, description, or dash if empty #}
                    <td class="py-2 px-4 text-sm text-gray-900 dark:text-dark-text">{{ transaction.item_name or '-' }}</td>
                    {# Amount column with conditional color styling (green for income, red for expense) #}
                    <td class="py-2 px-4 font-semibold {% if transaction.transaction_type == 'income' %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %}">₱{{ "%.2f"|format(transaction.amount|float) }}</td>
                    {# Transaction type column (capitalized) #}
                    <td class="py-2 px-4 capitalize text-sm text-gray-900 dark:text-dark-text">{{ transaction.transaction_type }}</td>
                    {# Actions column with edit and delete buttons #}
                    <td class="py-2 px-4 text-sm">
                        {# Edit button - opens modal with transaction data pre-filled #}
                        <button type="button" 
                                onclick="openEditTransactionModal({{ transaction.id }}, '{{ '%.2f'|format(transaction.amount) }}', '{{ transaction.item_name|e }}', '{{ transaction.date }}', '{{ transaction.transaction_type }}', '{{ transaction.category_id if transaction.category_id else '' }}')" 
                                class="text-blue-600 hover:text-blue-800 mr-2 dark:text-blue-400 dark:hover:text-blue-200">Edit</button>
                        {# Delete button - uses AJAX for smooth deletion, no confirmation #}
                        <button type="button" 
                                onclick="deleteTransaction({{ transaction.id }})" 
                                class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    {# No transactions message - displayed when no transactions are found #}
    <p class="text-gray-500 text-center py-8 dark:text-gray-400">No transactions found for the selected period.</p>
    {% endif %}
</div>

{# Edit Transaction Modal - overlay popup for editing transaction details #}
<div id="editTransactionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md mx-auto dark:bg-dark-bg-1 dark:shadow-2xl">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 dark:text-dark-text">Edit Transaction</h2>
        {# Edit transaction form with all necessary fields #}
        <form id="editTransactionForm" method="POST" action="" class="space-y-4">
            {# Hidden fields for transaction ID and type #}
            <input type="hidden" name="transaction_id" id="modal_transaction_id">
            <input type="hidden" name="type" id="modal_transaction_type">

            {# Transaction type selection dropdown #}
            <div>
                <label for="modal_transaction_type_select" class="block text-sm font-medium text-gray-700 mb-1 dark:text-cbd5e0">Transaction Type</label>
                <select id="modal_transaction_type_select" name="transaction_type" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
            </div>

            {# Amount input field #}
            <div>
                <label for="modal_amount" class="block text-sm font-medium text-gray-700 mb-1 dark:text-cbd5e0">Amount</label>
                <input type="number" id="modal_amount" name="amount" step="0.01" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
            </div>

            {# Category selection dropdown #}
            <div>
                <label for="modal_category_id" class="block text-sm font-medium text-gray-700 mb-1 dark:text-cbd5e0">Category</label>
                <select id="modal_category_id" name="category_id" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
                </select>
            </div>

            {# Date input field #}
            <div>
                <label for="modal_date" class="block text-sm font-medium text-gray-700 mb-1 dark:text-cbd5e0">Date</label>
                <input type="date" id="modal_date" name="date" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
            </div>

            {# Item Name input field #}
            <div>
                <label for="modal_item_name" class="block text-sm font-medium text-gray-700 mb-1 dark:text-cbd5e0">Item Name</label>
                <input type="text" id="modal_item_name" name="item_name" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
            </div>

            {# Modal action buttons #}
            <div class="flex justify-end space-x-3 mt-6">
                {# Cancel button - closes modal without saving #}
                <button type="button" onclick="closeEditTransactionModal()"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-medium dark:bg-gray-600 dark:text-dark-text dark:hover:bg-gray-500">
                    Cancel
                </button>
                {# Save button - submits form to update transaction #}
                <button type="submit"
                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 font-medium">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

{# JavaScript section - handles all interactive functionality #}
<script>
    {# Auto-fade notifications #}
    document.addEventListener('DOMContentLoaded', function() {
        const notifications = document.querySelectorAll('.notification');
        notifications.forEach(notification => {
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 3000);
        });
    });

    {# Get references to filter dropdown elements #}
    const periodSelect = document.getElementById('periodSelect');
    const typeSelect = document.getElementById('typeSelect');

    {# Add event listeners for filter changes #}
    periodSelect.addEventListener('change', filterTransactions);
    typeSelect.addEventListener('change', filterTransactions);

    {# Function to handle filter changes and redirect with new parameters #}
    function filterTransactions() {
        const period = periodSelect.value;
        const type = typeSelect.value;
        
        // Show/hide custom date range pickers
        const customDateRange = document.getElementById('customDateRange');
        if (period === 'custom') {
            customDateRange.classList.remove('hidden');
        } else {
            customDateRange.classList.add('hidden');
            window.location.href = `{{ url_for('main.history') }}?period=${period}&type=${type}`;
        }
    }

    {# Function to apply custom date range #}
    function applyCustomRange() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const type = typeSelect.value;
        
        if (startDate && endDate) {
            if (startDate > endDate) {
                alert('Start date must be before or equal to end date.');
                return;
            }
            window.location.href = `{{ url_for('main.history') }}?period=custom&type=${type}&start=${startDate}&end=${endDate}`;
        } else {
            alert('Please select both start and end dates.');
        }
    }

    {# Chart instances to prevent memory leaks when recreating charts #}
    let incomeChartInstance = null;
    let expenseChartInstance = null;

    {# Function to load chart data and update charts #}
    function loadChartData(chartType, period) {
        fetch(`/get_chart_data/${chartType}?period=${period}&mode=individual`)
            .then(response => response.json())
            .then(data => {
                const canvasId = `${chartType}Chart`;
                const legendId = `${chartType}ChartLegend`;
                const noDataMessageId = `${chartType}NoDataMessage`;
                
                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');
                const noDataMessageDiv = document.getElementById(noDataMessageId);
                
                // Destroy existing chart instance
                if (chartType === 'income' && incomeChartInstance) {
                    incomeChartInstance.destroy();
                    incomeChartInstance = null;
                } else if (chartType === 'expense' && expenseChartInstance) {
                    expenseChartInstance.destroy();
                    expenseChartInstance = null;
                }
                
                if (data && data.length > 0) {
                    // Show canvas and hide no data message
                    canvas.style.display = 'block';
                    noDataMessageDiv.classList.add('hidden');
                    
                    // Extract data for chart
                    const labels = data.map(item => item.name);
                    const values = data.map(item => item.value);
                    const colors = data.map(item => item.color);
                    
                    // Create new pie chart
                    const newChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: values,
                                backgroundColor: colors,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed !== null) {
                                                label += '₱' + context.parsed.toFixed(2);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Store chart instance
                    if (chartType === 'income') {
                        incomeChartInstance = newChart;
                    } else if (chartType === 'expense') {
                        expenseChartInstance = newChart;
                    }
                    
                    // Create custom legend
                    const legend = document.getElementById(legendId);
                    legend.innerHTML = '';
                    data.forEach(item => {
                        const legendItem = document.createElement('div');
                        legendItem.className = 'flex items-center justify-between p-2 bg-gray-50 rounded dark:bg-gray-700 dark:text-dark-text';
                        const colorClass = chartType === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                        legendItem.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <div class="w-4 h-4 rounded" style="background-color: ${item.color}"></div>
                                <span class="text-gray-700 dark:text-dark-text">${item.name}</span>
                            </div>
                            <span class="font-semibold ${colorClass}">₱${item.value.toFixed(2)}</span>
                        `;
                        legend.appendChild(legendItem);
                    });
                } else {
                    // No data available
                    canvas.style.display = 'none';
                    noDataMessageDiv.classList.remove('hidden');
                    document.getElementById(legendId).innerHTML = '';
                }
            })
            .catch(error => {
                console.error(`Error loading ${chartType} chart data:`, error);
                const canvas = document.getElementById(`${chartType}Chart`);
                const noDataMessageDiv = document.getElementById(`${chartType}NoDataMessage`);
                canvas.style.display = 'none';
                noDataMessageDiv.classList.remove('hidden');
                noDataMessageDiv.textContent = 'Error loading chart data.';
                document.getElementById(`${chartType}ChartLegend`).innerHTML = '';
            });
    }

    {# Function to load summary statistics #}
    function loadSummary(period, type) {
        // Calculate totals from visible transaction rows
        let totalIncome = 0;
        let totalExpenses = 0;
        
        const tableRows = document.querySelectorAll('tbody tr[id^="transaction-row-"]');
        tableRows.forEach(row => {
            // Skip hidden rows
            if (row.style.display === 'none') {
                return;
            }
            
            const typeCell = row.querySelector('td:nth-child(5)'); // Type column
            const amountCell = row.querySelector('td:nth-child(4)'); // Amount column
            
            if (typeCell && amountCell) {
                const transactionType = typeCell.textContent.trim().toLowerCase();
                const amountText = amountCell.textContent.replace('₱', '').trim();
                const amount = parseFloat(amountText) || 0;
                
                if (transactionType === 'income') {
                    totalIncome += amount;
                } else if (transactionType === 'expense') {
                    totalExpenses += amount;
                }
            }
        });
        
        // Update summary display
        document.getElementById('totalIncome').textContent = `₱${totalIncome.toFixed(2)}`;
        document.getElementById('totalExpenses').textContent = `₱${totalExpenses.toFixed(2)}`;
        
        const netBalance = totalIncome - totalExpenses;
        const netBalanceElement = document.getElementById('netBalance');
        netBalanceElement.textContent = `₱${netBalance.toFixed(2)}`;
        
        // Color code the net balance
        if (netBalance > 0) {
            netBalanceElement.className = 'text-3xl font-bold text-green-600 dark:text-green-300';
        } else if (netBalance < 0) {
            netBalanceElement.className = 'text-3xl font-bold text-red-600 dark:text-red-300';
        } else {
            netBalanceElement.className = 'text-3xl font-bold text-gray-800 dark:text-dark-text';
        }
    }

    {# Global variable to store all categories for dropdown population #}
    let allCategories = {{ all_categories|tojson|safe }};

    {# Initialize page when DOM is fully loaded #}
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Categories loaded:", allCategories);

        {# Get URL parameters for initial filter values #}
        const urlParams = new URLSearchParams(window.location.search);
        const urlPeriod = urlParams.get('period') || periodSelect.value;
        const urlType = urlParams.get('type') || typeSelect.value;
        const urlStartDate = urlParams.get('start');
        const urlEndDate = urlParams.get('end');

        {# Set filter dropdowns to URL parameter values #}
        periodSelect.value = urlPeriod;
        typeSelect.value = urlType;

        {# Handle custom date range initialization #}
        const customDateRange = document.getElementById('customDateRange');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        if (urlPeriod === 'custom') {
            customDateRange.classList.remove('hidden');
            if (urlStartDate) startDateInput.value = urlStartDate;
            if (urlEndDate) endDateInput.value = urlEndDate;
        } else {
            customDateRange.classList.add('hidden');
        }

        {# Load initial chart data and summary based on URL parameters #}
        if (urlType === 'both') {
            loadChartData('income', urlPeriod);
            loadChartData('expense', urlPeriod);
        } else if (urlType === 'income') {
            loadChartData('income', urlPeriod);
            // Hide expense chart initially
            const expenseCanvas = document.getElementById('expenseChart');
            const expenseLegend = document.getElementById('expenseChartLegend');
            if (expenseCanvas) expenseCanvas.style.display = 'none';
            if (expenseLegend) expenseLegend.innerHTML = `<p class="text-gray-500 text-center dark:text-gray-400">Income only view - expense chart hidden</p>`;
        } else if (urlType === 'expense') {
            loadChartData('expense', urlPeriod);
            // Hide income chart initially
            const incomeCanvas = document.getElementById('incomeChart');
            const incomeLegend = document.getElementById('incomeChartLegend');
            if (incomeCanvas) incomeCanvas.style.display = 'none';
            if (incomeLegend) incomeLegend.innerHTML = `<p class="text-gray-500 text-center dark:text-gray-400">Expense only view - income chart hidden</p>`;
        }
        loadSummary(urlPeriod, urlType);

        {# Add event listener for period filter changes #}
        periodSelect.addEventListener('change', function() {
            const selectedPeriod = this.value;
            const selectedType = typeSelect.value;
            
            if (selectedPeriod === 'custom') {
                customDateRange.classList.remove('hidden');
            } else {
                customDateRange.classList.add('hidden');
                
                // Update charts based on current type selection
                if (selectedType === 'both') {
                    loadChartData('income', selectedPeriod);
                    loadChartData('expense', selectedPeriod);
                } else if (selectedType === 'income') {
                    loadChartData('income', selectedPeriod);
                    // Keep expense chart hidden
                    const expenseCanvas = document.getElementById('expenseChart');
                    const expenseLegend = document.getElementById('expenseChartLegend');
                    if (expenseCanvas) expenseCanvas.style.display = 'none';
                    if (expenseLegend) expenseLegend.innerHTML = `<p class="text-gray-500 text-center dark:text-gray-400">Income only view - expense chart hidden</p>`;
                } else if (selectedType === 'expense') {
                    loadChartData('expense', selectedPeriod);
                    // Keep income chart hidden
                    const incomeCanvas = document.getElementById('incomeChart');
                    const incomeLegend = document.getElementById('incomeChartLegend');
                    if (incomeCanvas) incomeCanvas.style.display = 'none';
                    if (incomeLegend) incomeLegend.innerHTML = `<p class="text-gray-500 text-center dark:text-gray-400">Expense only view - income chart hidden</p>`;
                }
                
                loadSummary(selectedPeriod, selectedType);
                window.location.href = `{{ url_for('main.history') }}?period=${selectedPeriod}&type=${selectedType}`;
            }
        });

        {# Add event listener for type filter changes #}
        typeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            const currentPeriod = periodSelect.value;
            
            // Filter transaction table rows based on type selection
            filterTransactionTable(selectedType);
            
            // Update charts based on type selection
            if (selectedType === 'both') {
                loadChartData('income', currentPeriod);
                loadChartData('expense', currentPeriod);
                // Show both charts
                const incomeCanvas = document.getElementById('incomeChart');
                const incomeLegend = document.getElementById('incomeChartLegend');
                const expenseCanvas = document.getElementById('expenseChart');
                const expenseLegend = document.getElementById('expenseChartLegend');
                if (incomeCanvas) incomeCanvas.style.display = 'block';
                if (expenseCanvas) expenseCanvas.style.display = 'block';
                if (incomeLegend) incomeLegend.innerHTML = '';
                if (expenseLegend) expenseLegend.innerHTML = '';
            } else if (selectedType === 'income') {
                loadChartData('income', currentPeriod);
                // Hide expense chart
                const expenseCanvas = document.getElementById('expenseChart');
                const expenseLegend = document.getElementById('expenseChartLegend');
                if (expenseCanvas) expenseCanvas.style.display = 'none';
                if (expenseLegend) expenseLegend.innerHTML = `<p class="text-gray-500 text-center dark:text-gray-400">Income only view - expense chart hidden</p>`;
            } else if (selectedType === 'expense') {
                loadChartData('expense', currentPeriod);
                // Hide income chart
                const incomeCanvas = document.getElementById('incomeChart');
                const incomeLegend = document.getElementById('incomeChartLegend');
                if (incomeCanvas) incomeCanvas.style.display = 'none';
                if (incomeLegend) incomeLegend.innerHTML = `<p class="text-gray-500 text-center dark:text-gray-400">Expense only view - income chart hidden</p>`;
            }
            
            loadSummary(currentPeriod, selectedType);
            
            if (currentPeriod === 'custom') {
                // Don't redirect for custom period, let user apply the range
                return;
            }
            window.location.href = `{{ url_for('main.history') }}?period=${currentPeriod}&type=${selectedType}`;
        });

        {# Add event listener for transaction type changes in modal #}
        const transactionTypeSelect = document.getElementById('modal_transaction_type_select');
        if (transactionTypeSelect) {
            transactionTypeSelect.addEventListener('change', function() {
                const selectedType = this.value;
                const transactionTypeInput = document.getElementById('modal_transaction_type');
                transactionTypeInput.value = selectedType;
                
                const categorySelect = document.getElementById('modal_category_id');
                const currentCategoryId = categorySelect.value;
                populateCategoryDropdown(selectedType, currentCategoryId);
            });
        }
        
        // Initial table filtering based on current type selection
        filterTransactionTable(typeSelect.value);
    });

    {# 
        Function to open edit transaction modal with pre-filled data
        Parameters:
        - transactionId: ID of transaction to edit
        - amount: current transaction amount
        - itemName: current transaction item name
        - date: current transaction date
        - type: current transaction type (income/expense)
        - categoryId: current category ID
    #}
    function openEditTransactionModal(transactionId, amount, itemName, date, type, categoryId) {
        console.log('Opening edit modal with:', { transactionId, amount, itemName, date, type, categoryId });
        
        {# Get references to modal elements #}
        const modal = document.getElementById('editTransactionModal');
        const form = document.getElementById('editTransactionForm');
        const amountInput = document.getElementById('modal_amount');
        const categorySelect = document.getElementById('modal_category_id');
        const dateInput = document.getElementById('modal_date');
        const itemNameInput = document.getElementById('modal_item_name');
        const transactionIdInput = document.getElementById('modal_transaction_id');
        const transactionTypeInput = document.getElementById('modal_transaction_type');
        const transactionTypeSelect = document.getElementById('modal_transaction_type_select');

        {# Populate form fields with current transaction data #}
        amountInput.value = amount;
        dateInput.value = date;
        itemNameInput.value = itemName;
        transactionIdInput.value = transactionId;
        transactionTypeInput.value = type;
        transactionTypeSelect.value = type;

        {# Set form action URL for submission #}
        form.action = `/edit_transaction/${transactionId}`;

        {# Populate category dropdown based on transaction type #}
        populateCategoryDropdown(type, categoryId);

        console.log('Modal populated, showing modal');
        modal.classList.remove('hidden');
    }

    {# 
        Function to populate category dropdown based on transaction type
        Parameters:
        - transactionType: 'income' or 'expense'
        - selectedCategoryId: currently selected category ID (if any)
    #}
    function populateCategoryDropdown(transactionType, selectedCategoryId) {
        const categorySelect = document.getElementById('modal_category_id');
        categorySelect.innerHTML = '<option value="">Select a category</option>';
        
        // Use server-side categories instead of AJAX call
        const allCategories = {{ all_categories|tojson|safe }};
        
        {# Filter categories based on transaction type #}
        const filteredCategories = allCategories.filter(cat => cat.type === transactionType);

        {# Add category options to dropdown #}
        filteredCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            {# Mark as selected if it matches the current category #}
            if (parseInt(selectedCategoryId) === category.id) {
                option.selected = true;
            }
            categorySelect.appendChild(option);
        });

        {# Reset selection if no category ID provided #}
        if (!selectedCategoryId) {
            categorySelect.value = "";
        }
    }

    {# Function to close edit transaction modal #}
    function closeEditTransactionModal() {
        document.getElementById('editTransactionModal').classList.add('hidden');
    }

    {# Function to delete transaction using AJAX for smooth deletion #}
    function deleteTransaction(transactionId) {
        // Remove confirmation dialog
        // Show loading state
        const row = document.getElementById(`transaction-row-${transactionId}`);
        if (row) {
            row.style.opacity = '0.5';
        }
        
        fetch(`/delete_transaction/${transactionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Smoothly remove the row from the table
                if (row) {
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(-100px)';
                    setTimeout(() => {
                        row.remove();
                        // Reload charts and summary
                        const currentPeriod = periodSelect.value;
                        const currentType = typeSelect.value;
                        loadChartData('income', currentPeriod);
                        loadChartData('expense', currentPeriod);
                        loadSummary(currentPeriod, currentType);
                    }, 300);
                }
                
                // Show success notification
                showNotification(data.message || 'Transaction deleted successfully!', 'success');
            } else {
                // Reset row opacity on error
                if (row) {
                    row.style.opacity = '1';
                }
                showNotification(data.message || 'Error deleting transaction.', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Reset row opacity on error
            if (row) {
                row.style.opacity = '1';
            }
            showNotification('Error deleting transaction. Please try again.', 'danger');
        });
    }

    {# Function to show notifications - improved to show only one at a time #}
    function showNotification(message, type) {
        const container = document.getElementById('notifications-container') || createNotificationContainer();
        
        // Clear existing notifications to show only one at a time
        container.innerHTML = '';
        
        const notification = document.createElement('div');
        notification.className = `notification p-4 mb-2 text-sm rounded-lg transition-all duration-500 ease-in-out ${type === 'danger' ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200' : 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200'}`;
        notification.textContent = message;
        container.appendChild(notification);
        
        // Auto-fade after 3 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                notification.remove();
            }, 500);
        }, 3000);
    }

    {# Function to create notification container if it doesn't exist #}
    function createNotificationContainer() {
        const container = document.createElement('div');
        container.id = 'notifications-container';
        container.className = 'mb-6';
        document.querySelector('.max-w-7xl').insertBefore(container, document.querySelector('.max-w-7xl').firstChild);
        return container;
    }

    {# Add click event listener to close modal when clicking outside #}
    document.getElementById('editTransactionModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditTransactionModal();
        }
    });

    {# Add form submission event listener for debugging #}
    document.getElementById('editTransactionForm').addEventListener('submit', function(e) {
        console.log('Form submitted');
        const formData = new FormData(this);
        console.log('Form data:', Object.fromEntries(formData));
    });

    {# 
        Function to filter transaction table rows based on type selection
        Parameters:
        - selectedType: 'income', 'expense', or 'both'
    #}
    function filterTransactionTable(selectedType) {
        const tableRows = document.querySelectorAll('tbody tr[id^="transaction-row-"]');
        
        tableRows.forEach(row => {
            const typeCell = row.querySelector('td:nth-child(5)'); // Type column (5th column)
            if (typeCell) {
                const transactionType = typeCell.textContent.trim().toLowerCase();
                
                if (selectedType === 'both') {
                    // Show all rows
                    row.style.display = '';
                } else if (selectedType === 'income' && transactionType === 'income') {
                    // Show only income rows
                    row.style.display = '';
                } else if (selectedType === 'expense' && transactionType === 'expense') {
                    // Show only expense rows
                    row.style.display = '';
                } else {
                    // Hide rows that don't match the selected type
                    row.style.display = 'none';
                }
            }
        });
        
        // Update summary calculations after filtering
        const currentPeriod = periodSelect.value;
        updateSummary(currentPeriod, selectedType);
    }

    {# Function to update summary calculations dynamically #}
    function updateSummary(period, type) {
        // Calculate totals from visible transaction rows
        let totalIncome = 0;
        let totalExpenses = 0;
        
        const tableRows = document.querySelectorAll('tbody tr[id^="transaction-row-"]');
        tableRows.forEach(row => {
            // Skip hidden rows
            if (row.style.display === 'none') {
                return;
            }
            
            const typeCell = row.querySelector('td:nth-child(5)'); // Type column
            const amountCell = row.querySelector('td:nth-child(4)'); // Amount column
            
            if (typeCell && amountCell) {
                const transactionType = typeCell.textContent.trim().toLowerCase();
                const amountText = amountCell.textContent.replace('₱', '').trim();
                const amount = parseFloat(amountText) || 0;
                
                if (transactionType === 'income') {
                    totalIncome += amount;
                } else if (transactionType === 'expense') {
                    totalExpenses += amount;
                }
            }
        });
        
        // Update summary display
        document.getElementById('totalIncome').textContent = `₱${totalIncome.toFixed(2)}`;
        document.getElementById('totalExpenses').textContent = `₱${totalExpenses.toFixed(2)}`;
        
        const netBalance = totalIncome - totalExpenses;
        const netBalanceElement = document.getElementById('netBalance');
        netBalanceElement.textContent = `₱${netBalance.toFixed(2)}`;
        
        // Color code the net balance
        if (netBalance > 0) {
            netBalanceElement.className = 'text-3xl font-bold text-green-600 dark:text-green-300';
        } else if (netBalance < 0) {
            netBalanceElement.className = 'text-3xl font-bold text-red-600 dark:text-red-300';
        } else {
            netBalanceElement.className = 'text-3xl font-bold text-gray-800 dark:text-dark-text';
        }
    }
</script>
{% endblock %}
